<!DOCTYPE html>
<html>
<head>
    <title>Red Cross Emergency Operations Dashboard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Use reliable CDN for Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        
        .header {
            background: #DC143C;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: bold;
        }
        
        .header .subtitle {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 2px;
        }
        
        .status-bar {
            background: white;
            padding: 10px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-item {
            text-align: center;
            min-width: 100px;
        }
        
        .status-number {
            font-size: 24px;
            font-weight: bold;
            color: #DC143C;
        }
        
        .status-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 120px);
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .control-panel {
            width: 350px;
            background: white;
            border-left: 1px solid #ddd;
            overflow-y: auto;
        }
        
        .panel-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .panel-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .scan-button {
            width: 100%;
            background: #DC143C;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        .scan-button:hover {
            background: #B71C1C;
        }
        
        .scan-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .event-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #DC143C;
        }
        
        .event-type {
            font-weight: bold;
            font-size: 13px;
            color: #DC143C;
            margin-bottom: 5px;
        }
        
        .event-location {
            font-size: 12px;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .event-coords {
            font-family: monospace;
            font-size: 11px;
            color: #6c757d;
            background: #e9ecef;
            padding: 2px 4px;
            border-radius: 2px;
        }
        
        .shelter-alert {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        .no-events {
            text-align: center;
            color: #28a745;
            padding: 20px;
            font-weight: bold;
        }
        
        .last-update {
            font-size: 10px;
            color: #999;
            text-align: center;
            padding: 10px;
        }
        
        /* Custom marker styles */
        .disaster-marker {
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .weather-marker { background: #ff4444; }
        .earthquake-marker { background: #ff8800; }
        .fire-marker { background: #cc0000; }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>üè† American Red Cross - Emergency Operations</h1>
            <div class="subtitle">Disaster Response & Shelter Deployment Dashboard</div>
        </div>
        <div style="text-align: right; font-size: 12px;">
            <div id="currentTime"></div>
            <div>Emergency Management</div>
        </div>
    </div>
    
    <div class="status-bar">
        <div class="status-item">
            <div class="status-number" id="weatherCount">-</div>
            <div class="status-label">Weather Alerts</div>
        </div>
        <div class="status-item">
            <div class="status-number" id="earthquakeCount">-</div>
            <div class="status-label">Earthquakes</div>
        </div>
        <div class="status-item">
            <div class="status-number" id="fireCount">-</div>
            <div class="status-label">Wildfires</div>
        </div>
        <div class="status-item">
            <div class="status-number" id="shelterCount">-</div>
            <div class="status-label">Shelter Events</div>
        </div>
        <div class="status-item">
            <div style="font-size: 12px; color: #DC143C;" id="lastScan">Never</div>
            <div class="status-label">Last Scan</div>
        </div>
    </div>
    
    <div class="main-container">
        <div class="map-container">
            <div id="map"></div>
        </div>
        
        <div class="control-panel">
            <div class="panel-section">
                <div class="panel-title">Operations Control</div>
                <button class="scan-button" onclick="scanDisasters()" id="scanBtn">
                    üîç Scan for Active Disasters
                </button>
                <div style="font-size: 11px; color: #666; line-height: 1.4;">
                    Monitors NOAA weather alerts, USGS earthquakes, and NASA wildfire detections across all US territory.
                </div>
            </div>
            
            <div class="panel-section">
                <div class="panel-title">Shelter Deployment Events</div>
                <div id="shelterEvents">
                    <div class="loading">Click scan to check for events requiring shelter response</div>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="panel-title">All Active Events</div>
                <div id="allEvents">
                    <div class="loading">No data loaded</div>
                </div>
            </div>
            
            <div class="last-update">
                System operational ‚Ä¢ Real-time monitoring
            </div>
        </div>
    </div>

    <script>
        // Initialize map with reliable tile server
        const map = L.map('map').setView([39.8, -98.6], 4);
        
        // Use OpenStreetMap tiles (most reliable, no auth needed)
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        // Create marker groups
        const weatherGroup = L.layerGroup().addTo(map);
        const earthquakeGroup = L.layerGroup().addTo(map);
        const fireGroup = L.layerGroup().addTo(map);
        
        // Data storage
        let currentData = {
            weather: [],
            earthquakes: [],
            fires: []
        };
        
        // Update clock
        function updateClock() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString();
        }
        setInterval(updateClock, 1000);
        updateClock();
        
        async function scanDisasters() {
            const scanBtn = document.getElementById('scanBtn');
            scanBtn.disabled = true;
            scanBtn.textContent = 'üîç Scanning...';
            
            // Clear existing data
            weatherGroup.clearLayers();
            earthquakeGroup.clearLayers();
            fireGroup.clearLayers();
            currentData = { weather: [], earthquakes: [], fires: [] };
            
            try {
                await Promise.all([
                    loadWeatherData(),
                    loadEarthquakeData(),
                    loadFireData()
                ]);
                
                updateDisplay();
                document.getElementById('lastScan').textContent = new Date().toLocaleTimeString();
                
            } catch (error) {
                console.error('Scan error:', error);
                alert('Error scanning for disasters. Please try again.');
            }
            
            scanBtn.disabled = false;
            scanBtn.textContent = 'üîç Scan for Active Disasters';
        }
        
        async function loadWeatherData() {
            try {
                const response = await fetch('https://api.weather.gov/alerts/active');
                const data = await response.json();
                
                for (const alert of data.features) {
                    const props = alert.properties;
                    
                    // Skip test messages
                    if (props.event === 'Test Message') continue;
                    
                    const geometry = alert.geometry;
                    if (geometry && geometry.type === 'Polygon') {
                        const coords = geometry.coordinates[0];
                        const centerLat = coords.reduce((sum, p) => sum + p[1], 0) / coords.length;
                        const centerLon = coords.reduce((sum, p) => sum + p[0], 0) / coords.length;
                        
                        // US bounds check
                        if (centerLat >= 18.9 && centerLat <= 71.4 && 
                            centerLon >= -179.0 && centerLon <= -66.9) {
                            
                            const event = {
                                type: props.event || 'Weather Alert',
                                severity: props.severity || 'Unknown',
                                area: props.areaDesc || 'Unknown area',
                                headline: props.headline || '',
                                expires: props.expires,
                                lat: centerLat,
                                lon: centerLon,
                                requiresShelter: isShelterEvent(props.event, props.severity)
                            };
                            
                            currentData.weather.push(event);
                            addWeatherMarker(event);
                        }
                    }
                }
            } catch (error) {
                console.error('Weather data error:', error);
            }
        }
        
        async function loadEarthquakeData() {
            try {
                const response = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/significant_week.geojson');
                const data = await response.json();
                
                for (const quake of data.features) {
                    const props = quake.properties;
                    const coords = quake.geometry.coordinates;
                    const mag = props.mag || 0;
                    
                    // US bounds check
                    if (coords[1] >= 18.9 && coords[1] <= 71.4 && 
                        coords[0] >= -179.0 && coords[0] <= -66.9) {
                        
                        const event = {
                            magnitude: mag,
                            location: props.place || 'Unknown location',
                            time: new Date(props.time).toLocaleString(),
                            lat: coords[1],
                            lon: coords[0],
                            requiresShelter: mag >= 5.5
                        };
                        
                        currentData.earthquakes.push(event);
                        addEarthquakeMarker(event);
                    }
                }
            } catch (error) {
                console.error('Earthquake data error:', error);
            }
        }
        
        async function loadFireData() {
            try {
                const response = await fetch('https://firms.modaps.eosdis.nasa.gov/data/active_fire/modis-c6.1/csv/MODIS_C6_1_USA_contiguous_and_Hawaii_24h.csv');
                const text = await response.text();
                const lines = text.split('\n');
                
                for (let i = 1; i < lines.length && i < 100; i++) { // Limit to prevent overwhelming
                    if (lines[i].trim()) {
                        const parts = lines[i].split(',');
                        const lat = parseFloat(parts[0]);
                        const lon = parseFloat(parts[1]);
                        const confidence = parseInt(parts[8]);
                        const frp = parseFloat(parts[11]);
                        
                        if (confidence >= 80 && frp >= 50) {
                            const event = {
                                confidence: confidence,
                                frp: frp,
                                lat: lat,
                                lon: lon,
                                date: parts[5],
                                requiresShelter: frp >= 200
                            };
                            
                            currentData.fires.push(event);
                            addFireMarker(event);
                        }
                    }
                }
            } catch (error) {
                console.error('Fire data error:', error);
            }
        }
        
        function isShelterEvent(event, severity) {
            const shelterEvents = [
                'Hurricane Warning', 'Hurricane Watch', 'Tornado Warning',
                'Flash Flood Warning', 'Flood Warning', 'Blizzard Warning'
            ];
            return shelterEvents.includes(event) || severity === 'Extreme';
        }
        
        function addWeatherMarker(event) {
            const color = event.severity === 'Extreme' ? '#8B0000' : 
                         event.severity === 'Severe' ? '#FF0000' : '#FF8C00';
            
            const marker = L.circleMarker([event.lat, event.lon], {
                radius: event.requiresShelter ? 10 : 7,
                fillColor: color,
                color: 'white',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            });
            
            const popup = `
                <b>üå™Ô∏è ${event.type}</b><br>
                <b>Severity:</b> ${event.severity}<br>
                <b>Area:</b> ${event.area}<br>
                ${event.requiresShelter ? '<b style="color: red;">‚ö†Ô∏è SHELTER DEPLOYMENT RECOMMENDED</b><br>' : ''}
                <b>Coordinates:</b> ${event.lat.toFixed(3)}, ${event.lon.toFixed(3)}
            `;
            
            marker.bindPopup(popup);
            marker.addTo(weatherGroup);
        }
        
        function addEarthquakeMarker(event) {
            const size = event.magnitude >= 6 ? 12 : event.magnitude >= 5 ? 9 : 6;
            const color = event.magnitude >= 6 ? '#8B0000' : '#FF8800';
            
            const marker = L.circleMarker([event.lat, event.lon], {
                radius: size,
                fillColor: color,
                color: 'white',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            });
            
            const popup = `
                <b>üåç M${event.magnitude} Earthquake</b><br>
                <b>Location:</b> ${event.location}<br>
                <b>Time:</b> ${event.time}<br>
                ${event.requiresShelter ? '<b style="color: red;">‚ö†Ô∏è SHELTER DEPLOYMENT RECOMMENDED</b><br>' : ''}
                <b>Coordinates:</b> ${event.lat.toFixed(3)}, ${event.lon.toFixed(3)}
            `;
            
            marker.bindPopup(popup);
            marker.addTo(earthquakeGroup);
        }
        
        function addFireMarker(event) {
            const size = event.frp >= 200 ? 8 : 5;
            const color = event.frp >= 200 ? '#8B0000' : '#CC0000';
            
            const marker = L.circleMarker([event.lat, event.lon], {
                radius: size,
                fillColor: color,
                color: 'white',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            });
            
            const popup = `
                <b>üî• Active Fire</b><br>
                <b>Confidence:</b> ${event.confidence}%<br>
                <b>Power:</b> ${event.frp} MW<br>
                ${event.requiresShelter ? '<b style="color: red;">‚ö†Ô∏è SHELTER DEPLOYMENT RECOMMENDED</b><br>' : ''}
                <b>Coordinates:</b> ${event.lat.toFixed(3)}, ${event.lon.toFixed(3)}
            `;
            
            marker.bindPopup(popup);
            marker.addTo(fireGroup);
        }
        
        function updateDisplay() {
            // Update counts
            document.getElementById('weatherCount').textContent = currentData.weather.length;
            document.getElementById('earthquakeCount').textContent = currentData.earthquakes.length;
            document.getElementById('fireCount').textContent = currentData.fires.length;
            
            // Count shelter events
            const shelterEvents = [
                ...currentData.weather.filter(e => e.requiresShelter),
                ...currentData.earthquakes.filter(e => e.requiresShelter),
                ...currentData.fires.filter(e => e.requiresShelter)
            ];
            document.getElementById('shelterCount').textContent = shelterEvents.length;
            
            // Update shelter events panel
            const shelterPanel = document.getElementById('shelterEvents');
            if (shelterEvents.length === 0) {
                shelterPanel.innerHTML = '<div class="no-events">‚úÖ No events requiring shelter deployment</div>';
            } else {
                let html = '';
                shelterEvents.forEach(event => {
                    html += '<div class="event-card">';
                    if (event.type) {
                        html += `<div class="event-type">üå™Ô∏è ${event.type}</div>`;
                        html += `<div class="event-location">${event.area}</div>`;
                    } else if (event.magnitude) {
                        html += `<div class="event-type">üåç M${event.magnitude} Earthquake</div>`;
                        html += `<div class="event-location">${event.location}</div>`;
                    } else {
                        html += `<div class="event-type">üî• Major Wildfire</div>`;
                        html += `<div class="event-location">Power: ${event.frp} MW</div>`;
                    }
                    html += `<div class="event-coords">${event.lat.toFixed(3)}, ${event.lon.toFixed(3)}</div>`;
                    html += '<div class="shelter-alert">‚ö†Ô∏è SHELTER DEPLOYMENT RECOMMENDED</div>';
                    html += '</div>';
                });
                shelterPanel.innerHTML = html;
            }
            
            // Update all events panel (show first 10)
            const allEventsPanel = document.getElementById('allEvents');
            const allEvents = [
                ...currentData.weather.map(e => ({...e, category: 'Weather'})),
                ...currentData.earthquakes.map(e => ({...e, category: 'Earthquake'})),
                ...currentData.fires.map(e => ({...e, category: 'Fire'}))
            ];
            
            if (allEvents.length === 0) {
                allEventsPanel.innerHTML = '<div class="loading">No events detected</div>';
            } else {
                let html = '';
                allEvents.slice(0, 10).forEach(event => {
                    html += '<div class="event-card">';
                    if (event.category === 'Weather') {
                        html += `<div class="event-type">üå™Ô∏è ${event.type}</div>`;
                        html += `<div class="event-location">${event.area}</div>`;
                    } else if (event.category === 'Earthquake') {
                        html += `<div class="event-type">üåç M${event.magnitude}</div>`;
                        html += `<div class="event-location">${event.location}</div>`;
                    } else {
                        html += `<div class="event-type">üî• Wildfire</div>`;
                        html += `<div class="event-location">Confidence: ${event.confidence}%</div>`;
                    }
                    html += `<div class="event-coords">${event.lat.toFixed(3)}, ${event.lon.toFixed(3)}</div>`;
                    html += '</div>';
                });
                allEventsPanel.innerHTML = html;
            }
        }
        
        // Auto-scan on load
        scanDisasters();
    </script>
</body>
</html>